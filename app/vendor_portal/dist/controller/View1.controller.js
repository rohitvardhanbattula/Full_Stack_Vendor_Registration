sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,r,o,i,s,a){"use strict";return e.extend("vendorportal.controller.View1",{getURL:function(){return sap.ui.require.toUrl("vendorportal")},onInit:function(){const e=this.getView();const t=new r({supplierData:{supplierName:"",businessPartnerId:"",mainAddress:{street:"",city:"",postalCode:"",country:"",region:""},primaryContact:{firstName:"",lastName:"",email:"",phone:""},categoryAndRegion:{category:"",region:""},additionalInfo:{details:""}},aiExtractedText:"",gstValidation:{results:[],overallStatus:"Pending"},uploadedFiles:[],suppliers:[],approvers:[]});this.getView().setModel(t);if(!this._oProgressDialog){i.load({id:e.getId(),name:"vendorportal.view.ProgressDialog",controller:this}).then(t=>{this._oProgressDialog=t;e.addDependent(t)})}["inpSupplierName","inpCountry","inpFirstName","inpEmail","inpCategory"].forEach(e=>{let t=this.byId(e);if(t){t.attachChange(e=>{if(e.getParameter("value")){e.getSource().setValueState("None")}})}})},_validateInputs:function(e){let t=true;const r={inpSupplierName:"Supplier Name is required",inpCountry:"Country is required",inpFirstName:"First Name is required",inpEmail:"Email is required",inpCategory:"Category is required"};e.forEach(e=>{let o=this.byId(e);if(o){if(!o.getValue()){o.setValueState("Error");o.setValueStateText(r[e]||"This field is required.");t=false}else{o.setValueState("None")}}});return t},onNextStep1:function(){if(this._validateInputs(["inpSupplierName","inpCountry"])){this.byId("createWizard").nextStep()}},onNextStep2:function(){if(this._validateInputs(["inpFirstName","inpEmail"])){this.byId("createWizard").nextStep()}},onNextStep3:function(){if(this._validateInputs(["inpCategory"])){this.byId("createWizard").nextStep()}},onNextStep4:function(){const e=this.getView().getModel().getProperty("/uploadedFiles")||[];if(e.length===0){o.warning("Please upload at least 1 file to proceed.");return}if(e.length>2){o.warning("You have uploaded more than 2 files. Please remove extra files before proceeding.");return}this.byId("createWizard").nextStep();this.byId("btnCreateSupplier").setEnabled(true)},onFileChange:function(e){this._newFiles=Array.from(e.getParameter("files")||[])},onAddFiles:function(){const e=this.getView().getModel();const r=this.byId("fileUploader");let i=e.getProperty("/uploadedFiles")||[];if(!this._newFiles||this._newFiles.length===0){t.show("Please choose files to add.");return}const s=i.length+this._newFiles.length;if(s>2){o.warning("You can upload a maximum of 2 files.");if(r)r.clear();this._newFiles=[];return}this._newFiles.forEach(e=>{const r=i.some(t=>t.name===e.name&&t.size===e.size);if(!r){i.push({documentId:Date.now().toString()+Math.random(),name:e.name,type:e.type,size:Math.round(e.size/1024),file:e})}else{t.show(`File "${e.name}" is already in the list.`)}});e.setProperty("/uploadedFiles",i);this._newFiles=[];if(r)r.clear()},onFileDeleted:function(e){const t=e.getSource().getBindingContext();const r=t.getProperty("documentId");const o=this.getView().getModel();let i=o.getProperty("/uploadedFiles")||[];i=i.filter(e=>e.documentId!==r);o.setProperty("/uploadedFiles",i)},_setStepStatus:function(e,t){const r=this.byId(`${e}BusyIndicator`);const o=this.byId(`${e}StatusIcon`);if(!r||!o)return;r.setVisible(t==="InProgress");o.setVisible(t!=="InProgress");if(t==="Success"){o.setSrc("sap-icon://accept");o.setColor("Positive")}else if(t==="Failed"){o.setSrc("sap-icon://decline");o.setColor("Negative")}},onSaveSupplier:async function(){const e=this.getView().getModel();const t=e.getProperty("/supplierData");const r=e.getProperty("/uploadedFiles")||[];if(r.length===0){o.warning("Please upload at least one file to proceed.");return}try{const e=await fetch(this.getURL()+`/odata/v4/supplier/checkIfSupplierExists`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({supplierName:t.supplierName})});if(e.ok){const r=await e.json();if(r.value===true){o.error(`A supplier with the name "${t.supplierName}" already exists.`);return}}else{const t=await e.json();o.error(t.error?.message||"Failed to check supplier existence.");return}}catch(e){o.error("An error occurred while checking for the supplier. Please try again.");console.error("Supplier check error:",e);return}if(this._oProgressDialog){this._oProgressDialog.open();this._setStepStatus("supplier","InProgress");this._setStepStatus("gst","InProgress");this.byId("progressDialogCloseButton").setEnabled(false)}try{const o=await this._extractTextFromFile(r[0].file);e.setProperty("/aiExtractedText",o);const i=/\b\d{2}[A-Z]{5}\d{4}[A-Z]{1}[A-Z\d]{1}Z[A-Z\d]\b/;const s=o.match(i);const a=s?s[0]:null;let n=null;if(a){n=await this._validateGST(a,t);e.setProperty("/gstValidation",n);this._setStepStatus("gst",n.overallStatus)}else{this._setStepStatus("gst","Failed");e.setProperty("/gstValidation/remarks","GSTIN could not be parsed from extracted text.")}await fetch(this.getURL()+`/odata/v4/supplier/createSupplierWithFiles`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({supplierData:t})});this._setStepStatus("supplier","Success");this._navigationDetails={supplierId:t.supplierName};if(o){await fetch(this.getURL()+`/odata/v4/supplier/saveextractedtext`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({suppliername:t.supplierName,extractedGstin:o})})}if(n&&n.results.length>0){const e=n.results.map(e=>fetch(this.getURL()+`/odata/v4/supplier/saveValidationResult`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({supplierName:t.supplierName,field:e.field,validationStatus:e.status,validationRemarks:e.remarks})}));await Promise.all(e)}if(r.length>0){const e=new FormData;e.append("supplierName",t.supplierName);r.forEach(t=>e.append("files",t.file));await fetch(this.getURL()+`/uploadattachments`,{method:"POST",body:e})}this._resetForm();const p=this.byId("createWizard");if(p)p.discardProgress(this.byId("step1"))}catch(e){console.error("An unexpected error occurred:",e);o.error("An unexpected error occurred during the submission process.");this._setStepStatus("supplier","Failed");this._setStepStatus("gst","Failed")}finally{if(this._oProgressDialog){this.byId("progressDialogCloseButton").setEnabled(true)}}},_extractTextFromFile:async function(e){try{const r=new FormData;r.append("file",e);const o=await fetch(this.getURL()+"/fileextraction",{method:"POST",body:r});if(!o.ok){const e=await o.json();t.show(e.error||"Failed to extract text from file.");return""}const i=await o.json();return i.extractedText||""}catch(e){console.error("Backend text extraction error:",e);return""}},_validateGST:async function(e,t){const r=e=>{if(!e){return""}return e.toLowerCase().replace(/[\s.,]/g,"")};try{const o=await fetch(this.getURL()+"/fetchGSTDetails",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gstin:e})});if(!o.ok){const e=await o.json();return{results:[],overallStatus:"Failed",remarks:e.error}}const i=await o.json();const s=[];let a="Success";const n=r(i.gstTradeName)===r(t.supplierName);s.push({field:"Trade Name",status:n?"Success":"Failed",remarks:n?"Match":`Expected: ${i.gstTradeName}`});if(!n)a="Failed";const p=i.gstPincode===t.mainAddress.postalCode;s.push({field:"Pincode",status:p?"Success":"Failed",remarks:p?"Match":`Expected: ${i.gstPincode}`});if(!p)a="Failed";return{results:s,overallStatus:a}}catch(e){return{results:[],overallStatus:"Failed",remarks:"Technical error during validation."}}},_resetForm:function(){const e=this.getView().getModel();e.setProperty("/supplierData",{supplierName:"",mainAddress:{street:"",city:"",postalCode:"",country:"",region:""},primaryContact:{firstName:"",lastName:"",email:"",phone:""},categoryAndRegion:{category:"",region:""},additionalInfo:{details:""}});e.setProperty("/uploadedFiles",[]);e.setProperty("/aiExtractedText","");e.setProperty("/gstValidation",{results:[],overallStatus:"Pending"});const t=this.byId("fileUploader");if(t)t.clear()},onCloseProgressDialog:function(){if(this._oProgressDialog){this._oProgressDialog.close()}if(this._navigationDetails&&this._navigationDetails.supplierId){const e=this.getOwnerComponent().getRouter();e.navTo("SupplierDetail",{supplierId:this._navigationDetails.supplierId});this._navigationDetails=null}},onExcel:function(){var e=this.getURL()+`/odata/v4/supplier/getsuppliers`;var r=this.getURL()+`/odata/v4/supplier/Approvers`;Promise.all([fetch(e).then(e=>e.json()),fetch(r).then(e=>e.json())]).then(([e,r])=>{var i=e.value||[];var s=r.value||[];var a=i.map(e=>({SupplierName:e.supplierName,City:e.mainAddress.city,Country:e.mainAddress.country}));var n=s.map(e=>({Level:e.level,Name:e.name,Email:e.email}));if(!Array.isArray(a)||!Array.isArray(n)){o.error("Export failed: invalid data format.");return}if(a.length===0&&n.length===0){o.warning("No data available to export.");return}var p=XLSX.utils.book_new();var l=XLSX.utils.json_to_sheet(a);var d=XLSX.utils.json_to_sheet(n);XLSX.utils.book_append_sheet(p,l,"Suppliers");XLSX.utils.book_append_sheet(p,d,"Approvers");XLSX.writeFile(p,"Suppliers_and_Approvers.xlsx");t.show("Excel downloaded successfully!")}).catch(function(e){o.error("Failed to fetch data: "+e.message)})},onOpenSupplierList:function(){this.getOwnerComponent().getRouter().navTo("SupplierList")},onCloseSupplierList:function(){if(this._oSupplierDialog)this._oSupplierDialog.close()},onOpenApproverList:async function(){const e=this.getView();if(!this._oApproverDialog){this._oApproverDialog=await i.load({id:e.getId(),name:"vendorportal.view.ApproverList",controller:this});e.addDependent(this._oApproverDialog)}const t=new r({approvers:[],newApprover:{name:"",email:"",level:"",country:""},selectedApprover:{},isEditEnabled:false});this._oApproverDialog.setModel(t,"approverModel");this._fetchApprovers();this.byId("approverTable").removeSelections(true);this.byId("approverSearchField").setValue("");t.setProperty("/isEditEnabled",false);this._oApproverDialog.open()},onCloseApproverList:function(){this._oApproverDialog.close()},_fetchApprovers:function(){const e=this._oApproverDialog.getModel("approverModel");fetch(this.getURL()+`/odata/v4/supplier/Approvers`).then(e=>e.json()).then(t=>{const r=Array.isArray(t.value)?t.value:[];e.setProperty("/approvers",r);this.byId("approverTableTitle").setText(`Approvers (${r.length})`)}).catch(e=>o.error("Error fetching approvers: "+e.message))},onSearchApprovers:function(e){const t=e.getParameter("newValue");const r=this.byId("approverTable");const o=r.getBinding("items");if(!o){return}if(t){const e=new s({filters:[new s("name",a.Contains,t,false),new s("email",a.Contains,t,false)],and:false});o.filter([e])}else{o.filter([])}},onApproverSelectionChange:function(e){const t=e.getSource().getSelectedItems().length>0;this._oApproverDialog.getModel("approverModel").setProperty("/isEditEnabled",t)},onCreateApprover:async function(){const e=this.getView();if(!this._oCreateApproverDialog){this._oCreateApproverDialog=await i.load({id:e.getId(),name:"vendorportal.view.CreateApprover",controller:this});e.addDependent(this._oCreateApproverDialog)}this._oCreateApproverDialog.setModel(this._oApproverDialog.getModel("approverModel"),"approverModel");this._oCreateApproverDialog.open()},onSaveApprover:async function(){const e=this._oApproverDialog.getModel("approverModel");const r=e.getProperty("/newApprover");if(!r.name||!r.email||!r.level||!r.country){o.warning("Please fill all required fields.");return}const i={approverentry:r};try{const r=await fetch(this.getURL()+`/odata/v4/supplier/approverentry`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(r.ok){const o=await r.json();t.show(o.value||"Approver created successfully.");this._fetchApprovers();e.setProperty("/newApprover",{name:"",email:"",level:"",country:""});this.onCancelApprover()}else{const e=await r.json();o.error(e.error?.message||"Failed to create approver.")}}catch(e){o.error("Error: "+e.message)}},onCancelApprover:function(){this._oCreateApproverDialog.close()},onUpdateApprover:async function(){const e=this.byId("approverTable").getSelectedItem();if(!e)return;const t=e.getBindingContext("approverModel").getObject();this._oApproverDialog.getModel("approverModel").setProperty("/selectedApprover",{...t});const r=this.getView();if(!this._oUpdateApproverDialog){this._oUpdateApproverDialog=await i.load({id:r.getId(),name:"vendorportal.view.UpdateApprover",controller:this});r.addDependent(this._oUpdateApproverDialog)}this._oUpdateApproverDialog.setModel(this._oApproverDialog.getModel("approverModel"),"approverModel");this._oUpdateApproverDialog.open()},onSaveUpdateApprover:async function(){const e=this._oApproverDialog.getModel("approverModel");const r=e.getProperty("/selectedApprover");const i={approverentry:r};try{const e=await fetch(this.getURL()+`/odata/v4/supplier/approverupdateentry`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(e.ok){const r=await e.json();t.show(r.value||"Approver updated successfully.");this._fetchApprovers();this.onCancelUpdateApprover()}else{const t=await e.json();o.error(t.error?.message||"Failed to update approver.")}}catch(e){o.error("Error: "+e.message)}},onCancelUpdateApprover:function(){this._oUpdateApproverDialog.close()},onDeleteApprover:function(){const e=this.byId("approverTable").getSelectedItem();if(!e){return}const r=e.getBindingContext("approverModel").getObject();o.confirm(`Are you sure you want to delete "${r.name}"?`,{title:"Confirm Deletion",onClose:async e=>{if(e!==o.Action.OK){return}const i={name:r.name,country:r.country,level:r.level};try{const e=await fetch(this.getURL()+`/odata/v4/supplier/deleteapprover`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(e.ok){t.show("Approver deleted.");this._fetchApprovers()}else{const t=await e.json();o.error(t.error?.message||"Deletion failed.")}}catch(e){o.error("An error occurred: "+e.message)}}})}})});
//# sourceMappingURL=View1.controller.js.map