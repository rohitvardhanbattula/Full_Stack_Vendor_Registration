sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/export/Spreadsheet"],function(e,t,i,r,o,s){"use strict";return e.extend("vendorportal.controller.View1",{getURL:function(){return sap.ui.require.toUrl("vendorportal")},onInit:function(){const e=this.getView();if(!this._oProgressDialog){o.load({id:e.getId(),name:"vendorportal.view.ProgressDialog",controller:this}).then(t=>{this._oProgressDialog=t;e.addDependent(t)})}const t=new i({supplierData:{supplierName:"",businessPartnerId:"",aiExtractedText:"",gstValidationStatus:"",gstValidationRemarks:"",mainAddress:{street:"",line2:"",line3:"",city:"",postalCode:"",country:"",region:""},primaryContact:{firstName:"",lastName:"",email:"",phone:""},categoryAndRegion:{category:"",region:""},additionalInfo:{details:""}},suppliers:[],uploadedFiles:[]});this.getView().setModel(t);["inpSupplierName","inpCountry","inpFirstName","inpEmail","inpCategory"].forEach(e=>{let t=this.byId(e);if(t){t.attachChange(function(e){if(e.getParameter("value")){e.getSource().setValueState("None")}})}})},_validateInputs:function(e){let t=true;const i={inpSupplierName:"Supplier Name is required",inpCountry:"Country is required",inpFirstName:"First Name is required",inpEmail:"Email is required",inpCategory:"Category is required"};e.forEach(e=>{let r=this.byId(e);if(r){if(!r.getValue()){r.setValueState("Error");r.setValueStateText(i[e]||"This field is required.");t=false}else{r.setValueState("None")}}});return t},onNextStep1:function(){if(this._validateInputs(["inpSupplierName","inpCountry"])){this.byId("createWizard").nextStep()}},onNextStep2:function(){if(this._validateInputs(["inpFirstName","inpEmail"])){this.byId("createWizard").nextStep()}},onNextStep3:function(){if(this._validateInputs(["inpCategory"])){this.byId("createWizard").nextStep()}},onNextStep4:function(){const e=this.getView().getModel().getProperty("/uploadedFiles")||[];if(e.length===0){r.warning("Please upload at least 1 file to proceed.");return}if(e.length>2){r.warning("You have uploaded more than 2 files. Please remove extra files before proceeding.");return}this.byId("createWizard").nextStep();this.byId("btnCreateSupplier").setEnabled(true)},onFileChange:function(e){this._newFiles=Array.from(e.getParameter("files")||[])},onAddFiles:function(){const e=this.getView().getModel();const i=this.byId("fileUploader");let o=e.getProperty("/uploadedFiles")||[];if(!this._newFiles||this._newFiles.length===0){t.show("Please choose files to add.");return}const s=o.length+this._newFiles.length;if(s>2){r.warning("You can upload a maximum of 2 files.");if(i)i.clear();this._newFiles=[];return}this._newFiles.forEach(e=>{const i=o.some(t=>t.name===e.name&&t.size===e.size);if(!i){o.push({documentId:Date.now().toString()+Math.random(),name:e.name,type:e.type,size:Math.round(e.size/1024),file:e})}else{t.show(`File "${e.name}" is already in the list.`)}});e.setProperty("/uploadedFiles",o);this._newFiles=[];if(i)i.clear()},onFileDeleted:function(e){const t=e.getSource().getBindingContext();const i=t.getProperty("documentId");const r=this.getView().getModel();let o=r.getProperty("/uploadedFiles")||[];o=o.filter(e=>e.documentId!==i);r.setProperty("/uploadedFiles",o)},_setStepStatus:function(e,t){const i=this.byId(`${e}BusyIndicator`);const r=this.byId(`${e}StatusIcon`);if(!i||!r){return}i.setVisible(t==="InProgress");r.setVisible(t!=="InProgress");if(t==="Success"){r.setSrc("sap-icon://accept");r.setColor("Positive")}else if(t==="Failed"){r.setSrc("sap-icon://decline");r.setColor("Negative")}},onSaveSupplier:async function(){const e=this.getView().getModel().getProperty("/supplierData");const t=this.getView().getModel().getProperty("/uploadedFiles")||[];let i="";let o="Not Performed";let s="No GST document found.";if(this._oProgressDialog){this._oProgressDialog.open();this._setStepStatus("gst","InProgress");this._setStepStatus("supplier","InProgress");this.byId("progressDialogCloseButton").setEnabled(false)}try{if(t.length>0){for(const r of t){const t=await this._extractGSTFromFile(r.file);if(t){i=t;const r=await this._validateGST(t,e);o=r.status;s=r.remarks;break}}}if(!i){o="Failed"}this._setStepStatus("gst",o);const a=await fetch(this.getURL()+`/odata/v4/supplier/createSupplierWithFiles`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({supplierData:e})});if(!a.ok){const e=await a.json();this._setStepStatus("supplier","Failed");r.error(e.error?.message||"Supplier creation failed.");return}this._setStepStatus("supplier","Success");if(t.length>0){const i=new FormData;i.append("supplierName",e.supplierName);t.forEach(e=>i.append("files",e.file));await fetch(this.getURL()+`/uploadattachments`,{method:"POST",body:i})}await fetch(this.getURL()+`/odata/v4/supplier/saveValidationResult`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({supplierName:e.supplierName,extractedGstin:i,validationStatus:o,validationRemarks:s})});this._resetForm();const n=this.byId("createWizard");if(n)n.discardProgress(this.byId("step1"))}catch(e){console.error("An unexpected error occurred:",e);this._setStepStatus("supplier","Failed");r.error("An unexpected error occurred during the submission process.")}finally{if(this._oProgressDialog){this.byId("progressDialogCloseButton").setEnabled(true)}}},_extractGSTFromFile:async function(e){try{const t=new FormData;t.append("file",e);const i=await fetch(this.getURL()+"/fileextraction",{method:"POST",body:t});if(!i.ok){console.error("Failed to extract GST from file.");return""}const r=await i.json();return r.gstin||""}catch(e){console.error("Backend GST extraction error:",e);return""}},_validateGST:async function(e,t){if(!e){return{status:"Failed",remarks:"GST Number could not be found for validation."}}try{const i=await fetch(this.getURL()+"/fetchGSTDetails",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gstin:e})});const r=await i.json();if(!i.ok){return{status:"Failed",remarks:r.error||"Error fetching GST details from external service."}}const o=[];const s=e=>e?.toLowerCase().replace(/\s+/g," ").trim();if(r.gstStatus!=="Active"){o.push("GST Number is not active.")}if(s(r.gstTradeName)!==s(t.supplierName)){o.push(`Trade Name mismatch: GST record has "${r.gstTradeName}".`)}if(r.gstPincode!==t.mainAddress.postalCode){o.push(`Pincode mismatch: GST record has "${r.gstPincode}".`)}if(o.length>0){return{status:"Failed",remarks:o.join("\n")}}return{status:"Success",remarks:"Validated successfully."}}catch(e){console.error("GST validation error:",e);return{status:"Failed",remarks:"A technical error occurred while validating the GST Number."}}},_resetForm:function(){const e=this.getView().getModel();e.setProperty("/supplierData",{supplierName:"",mainAddress:{street:"",line2:"",line3:"",city:"",postalCode:"",country:"",region:""},primaryContact:{firstName:"",lastName:"",email:"",phone:""},categoryAndRegion:{category:"",region:""},additionalInfo:{details:""}});e.setProperty("/uploadedFiles",[]);const t=this.byId("fileUploader");if(t)t.clear()},onCloseProgressDialog:function(){if(this._oProgressDialog){this._oProgressDialog.close()}},onExcel:function(){var e=this.getURL()+`/odata/v4/supplier/getsuppliers`;var i=this.getURL()+`/odata/v4/supplier/Approvers`;Promise.all([fetch(e).then(e=>e.json()),fetch(i).then(e=>e.json())]).then(([e,i])=>{var o=e.value||[];var s=i.value||[];var a=o.map(e=>({SupplierName:e.supplierName,City:e.mainAddress.city,Country:e.mainAddress.country}));var n=s.map(e=>({Level:e.level,Name:e.name,Email:e.email}));if(!Array.isArray(a)||!Array.isArray(n)){r.error("Export failed: invalid data format.");return}if(a.length===0&&n.length===0){r.warning("No data available to export.");return}var l=XLSX.utils.book_new();var p=XLSX.utils.json_to_sheet(a);var d=XLSX.utils.json_to_sheet(n);XLSX.utils.book_append_sheet(l,p,"Suppliers");XLSX.utils.book_append_sheet(l,d,"Approvers");XLSX.writeFile(l,"Suppliers_and_Approvers.xlsx");t.show("Excel downloaded successfully!")}).catch(function(e){r.error("Failed to fetch data: "+e.message)})},onOpenSupplierList:function(){this.getOwnerComponent().getRouter().navTo("SupplierList")},onCloseSupplierList:function(){if(this._oSupplierDialog)this._oSupplierDialog.close()},onOpenApproverList:async function(){var e=this.getView();if(!this._oApproverDialog){this._oApproverDialog=await o.load({id:e.getId(),name:"vendorportal.view.ApproverList",controller:this});e.addDependent(this._oApproverDialog)}const t=()=>{fetch(this.getURL()+`/odata/v4/supplier/Approvers`).then(e=>e.json()).then(e=>{const t=Array.isArray(e.value)?e.value:e;this.getView().getModel().setProperty("/approvers",t)}).catch(e=>{r.error("Error fetching approvers: "+e.message)})};t();this._approverInterval=setInterval(()=>{if(this._oApproverDialog&&this._oApproverDialog.isOpen()){t()}},3e3);this._oApproverDialog.open()},onCloseApproverList:function(){if(this._oApproverDialog){this._oApproverDialog.close()}if(this._approverInterval){clearInterval(this._approverInterval);this._approverInterval=null}},onCreateApprover:function(){var e=this.getView();if(!this.byId("createApproverDialog")){o.load({id:e.getId(),name:"vendorportal.view.CreateApprover",controller:this}).then(function(t){e.addDependent(t);t.open()})}else{this.byId("createApproverDialog").open()}},onUpdateApprover:function(){var e=this.getView();if(!this.byId("updateApproverDialog")){o.load({id:e.getId(),name:"vendorportal.view.UpdateApprover",controller:this}).then(function(t){e.addDependent(t);t.open()})}else{this.byId("updateApproverDialog").open()}},onSaveUpdateApprover:async function(){try{const e=this.byId("inputLevel1").getValue();const i=this.byId("inputCountry1").getValue();const o=this.byId("inputName1").getValue();const s=this.byId("inputEmail1").getValue();if(!e||!i||!o||!s){r.warning("Please fill all required fields.");return}const a={approverentry:{level:e,country:i,name:o,email:s}};const n=await fetch(this.getURL()+`/odata/v4/supplier/approverupdateentry`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});const l=await n.json();this.byId("inputLevel1").setValue("");this.byId("inputCountry1").setValue("");this.byId("inputName1").setValue("");this.byId("inputEmail1").setValue("");if(n.ok){t.show(l.value);this.byId("updateApproverDialog").close()}else{r.error(l.error?.message||"Failed to update approver")}}catch(e){r.error("Error: "+e.message)}},onSaveApprover:async function(){try{const e=this.byId("inputLevel").getValue();const i=this.byId("inputCountry").getValue();const o=this.byId("inputName").getValue();const s=this.byId("inputEmail").getValue();if(!e||!i||!o||!s){r.warning("Please fill all required fields.");return}const a={approverentry:{level:e,country:i,name:o,email:s}};const n=await fetch(this.getURL()+`/odata/v4/supplier/approverentry`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});const l=await n.json();this.byId("inputLevel").setValue("");this.byId("inputCountry").setValue("");this.byId("inputName").setValue("");this.byId("inputEmail").setValue("");if(n.ok){t.show(l.value);this.byId("createApproverDialog").close()}else{r.error(l.error?.message||"Failed to insert approver")}}catch(e){r.error("Error: "+e.message)}},onCancelApprover:function(){this.byId("createApproverDialog").close()},onCancelUpdateApprover:function(){this.byId("updateApproverDialog").close()}})});
//# sourceMappingURL=View1.controller.js.map