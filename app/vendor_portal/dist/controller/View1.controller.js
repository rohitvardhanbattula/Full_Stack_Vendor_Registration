sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/export/Spreadsheet"],function(e,t,r,i,o,a){"use strict";return e.extend("vendorportal.controller.View1",{_validateGST:async function(e,t){if(!e){await new Promise(e=>{sap.m.MessageBox.warning("Please upload GST Number related PDF",{onClose:()=>e()})});return false}try{const r=await fetch(this.getURL()+"/fetchGSTDetails",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gstin:e})});const i=await r.json();if(!r.ok){await new Promise(e=>{sap.m.MessageBox.error(i.error||"Error fetching GST details",{onClose:()=>e()})});return false}const o=[];if(i.gstStatus!=="Active"){o.push("GST Number is not active.")}const a=e=>e?.toLowerCase().replace(/\s+/g," ").trim();if(a(i.gstTradeName)!==a(t.supplierName)){o.push(`Trade Name (${i.gstTradeName}) does not match your Supplier Name (${t.supplierName})`)}if(i.gstPincode!==t.mainAddress.postalCode){o.push(`Pincode (${i.gstPincode}) does not match your Postal Code (${t.mainAddress.postalCode})`)}if(o.length>0){await new Promise(e=>{sap.m.MessageBox.error("GST details do not match:\n"+o.join("\n"),{onClose:()=>e()})});return false}return true}catch(e){console.error("Validation error:",e);await new Promise(e=>{sap.m.MessageBox.error("Error while validating GST Number.",{onClose:()=>e()})})}},_extractGSTFromFile:async function(e){try{const t=new FormData;t.append("file",e);const r=await fetch(this.getURL()+"/fileextraction",{method:"POST",body:t});if(!r.ok){throw new Error("Failed to extract GST")}const i=await r.json();return i.gstin||""}catch(e){console.error("Backend GST extraction error:",e);return""}},_readFileAsBase64:function(e){return new Promise((t,r)=>{const i=new FileReader;i.onload=function(e){const r=btoa(new Uint8Array(e.target.result).reduce((e,t)=>e+String.fromCharCode(t),""));t(r)};i.onerror=r;i.readAsArrayBuffer(e)})},onExcel:function(){var e=this.getURL()+`/odata/v4/supplier/getsuppliers`;var r=this.getURL()+`/odata/v4/supplier/Approvers`;Promise.all([fetch(e).then(e=>e.json()),fetch(r).then(e=>e.json())]).then(function([e,r]){var o=e.value||[];var a=r.value||[];var s=o.map(e=>({SupplierName:e.supplierName,City:e.mainAddress.city,Country:e.mainAddress.country}));var n=a.map(e=>({Level:e.level,Name:e.name,Email:e.email}));if(!Array.isArray(s)||!Array.isArray(n)){i.error("Export failed: invalid data format.");return}if(s.length===0&&n.length===0){i.warning("No data available to export.");return}var l=XLSX.utils.book_new();var p=XLSX.utils.json_to_sheet(s);var d=XLSX.utils.json_to_sheet(n);XLSX.utils.book_append_sheet(l,p,"Suppliers");XLSX.utils.book_append_sheet(l,d,"Approvers");XLSX.writeFile(l,"Suppliers_and_Approvers.xlsx");t.show("Excel downloaded successfully!")}).catch(function(e){i.error("Failed to fetch data: "+e.message)})},getURL:function(){return sap.ui.require.toUrl("vendorportal")},_validateInputs:function(e){let t=true;const r={inpSupplierName:"Supplier Name is required",inpCountry:"Country is required",inpFirstName:"First Name is required",inpEmail:"Email is required",inpCategory:"Category is required"};e.forEach(e=>{let i=this.byId(e);if(i){if(!i.getValue()){i.setValueState("Error");i.setValueStateText(r[e]||"This field is required.");t=false}else{i.setValueState("None")}}});return t},onNextStep1:function(){if(this._validateInputs(["inpSupplierName","inpCountry"])){this.byId("createWizard").nextStep()}},onNextStep2:function(){if(this._validateInputs(["inpFirstName","inpEmail"])){this.byId("createWizard").nextStep()}},onNextStep3:function(){if(this._validateInputs(["inpCategory"])){this.byId("createWizard").nextStep()}},onNextStep4:function(){const e=this.getView().getModel().getProperty("/uploadedFiles")||[];if(e.length===0){i.warning("Please upload at least 1 file to proceed.");return}if(e.length>2){sap.m.MessageBox.warning("You have uploaded more than 2 files. Please remove extra files before proceeding.");return}this.byId("createWizard").nextStep();this.byId("btnCreateSupplier").setEnabled(true)},onInit:function(){const e=this.getView();if(!this._oProgressDialog){o.load({id:e.getId(),name:"vendorportal.view.ProgressDialog",controller:this}).then(t=>{this._oProgressDialog=t;e.addDependent(t)})}const t=new r({supplierData:{supplierName:"",businessPartnerId:"",mainAddress:{street:"",line2:"",line3:"",city:"",postalCode:"",country:"",region:""},primaryContact:{firstName:"",lastName:"",email:"",phone:""},categoryAndRegion:{category:"",region:""},additionalInfo:{details:""}},suppliers:[],uploadedFiles:[]});this.getView().setModel(t);["inpSupplierName","inpCountry","inpFirstName","inpEmail","inpCategory"].forEach(e=>{let t=this.byId(e);if(t){t.attachChange(function(e){if(e.getParameter("value")){e.getSource().setValueState("None")}})}})},onCloseProgressDialog:function(){if(this._oProgressDialog)this._oProgressDialog.close()},onFileChange:function(e){this._newFiles=Array.from(e.getParameter("files")||[])},onAddFiles:function(){const e=this.getView().getModel();const t=this.byId("fileUploader");let r=e.getProperty("/uploadedFiles")||[];const o=r.length+this._newFiles.length;if(o>2){i.warning("You can upload a maximum of 2 files.");if(t)t.clear();return}this._newFiles.forEach(e=>{const t=r.some(t=>t.name===e.name&&t.size===e.size);if(!t){r.push({documentId:Date.now().toString()+Math.random(),name:e.name,type:e.type,size:Math.round(e.size/1024),file:e})}});e.setProperty("/uploadedFiles",r);this._newFiles=[];if(t)t.clear()},onFileDeleted:function(e){const t=e.getSource().getBindingContext();const r=t.getProperty("documentId");const i=this.getView().getModel();let o=i.getProperty("/uploadedFiles")||[];o=o.filter(e=>e.documentId!==r);i.setProperty("/uploadedFiles",o);this.byId("btnCreateSupplier").setEnabled(o.length>0)},_resetForm:function(){this.getView().getModel().setProperty("/supplierData",{supplierName:"",mainAddress:{street:"",line2:"",line3:"",city:"",postalCode:"",country:"",region:""},primaryContact:{firstName:"",lastName:"",email:"",phone:""},categoryAndRegion:{category:"",region:""},additionalInfo:{details:""}});this.getView().getModel().setProperty("/uploadedFiles",[]);const e=this.byId("fileUploader");if(e)e.clear()},onSaveSupplier:async function(){const e=this.getView().getModel().getProperty("/supplierData");const t=this.getView().getModel().getProperty("/uploadedFiles")||[];if(t.length>2){i.warning("Please add at max 2 files before saving.");return}if(this._oProgressDialog){this._oProgressDialog.open();this.byId("gstIcon").setSrc("sap-icon://synchronize").setColor("Neutral");this.byId("supplierIcon").setSrc("sap-icon://circle-task").setColor("Neutral")}sap.ui.core.BusyIndicator.show(0);try{let r=false;for(const i of t){const t=await this._extractGSTFromFile(i.file);if(t){const i=await this._validateGST(t,e);if(i){r=true;this.byId("gstIcon").setSrc("sap-icon://accept").setColor("Positive");break}}}if(!r){this.byId("gstIcon").setSrc("sap-icon://decline").setColor("Negative");return}const i=await fetch(this.getURL()+`/odata/v4/supplier/createSupplierWithFiles`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({supplierData:e})});const o=await i.json();this.byId("supplierIcon").setSrc("sap-icon://accept").setColor("Positive");if(t.length>0){const r=new FormData;r.append("supplierName",e.supplierName);t.forEach(e=>r.append("files",e.file));await fetch(this.getURL()+`/uploadattachments`,{method:"POST",body:r})}sap.m.MessageBox.success("Supplier created successfully with all validations & attachments!",{onClose:()=>{this._resetForm();const e=this.byId("createWizard");if(e)e.discardProgress(this.byId("step1"))}})}catch(e){console.error(e);this.byId("supplierIcon").setSrc("sap-icon://decline").setColor("Negative")}finally{sap.ui.core.BusyIndicator.hide();if(this._oProgressDialog){this._oProgressDialog.close()}}},onOpenSupplierList:function(){this.getOwnerComponent().getRouter().navTo("SupplierList")},onCloseSupplierList:function(){if(this._oSupplierDialog)this._oSupplierDialog.close()},onOpenApproverList:async function(){var e=this.getView();if(!this._oApproverDialog){this._oApproverDialog=await o.load({id:e.getId(),name:"vendorportal.view.ApproverList",controller:this});e.addDependent(this._oApproverDialog)}const t=()=>{fetch(this.getURL()+`/odata/v4/supplier/Approvers`).then(e=>e.json()).then(e=>{const t=Array.isArray(e.value)?e.value:e;this.getView().getModel().setProperty("/approvers",t)}).catch(e=>{i.error("Error fetching approvers: "+e.message)})};t();this._approverInterval=setInterval(()=>{if(this._oApproverDialog&&this._oApproverDialog.isOpen()){t()}},3e3);this._oApproverDialog.open()},onCloseApproverList:function(){if(this._oApproverDialog){this._oApproverDialog.close()}if(this._approverInterval){clearInterval(this._approverInterval);this._approverInterval=null}},onCreateApprover:function(){var e=this.getView();if(!this.byId("createApproverDialog")){o.load({id:e.getId(),name:"vendorportal.view.CreateApprover",controller:this}).then(function(t){e.addDependent(t);t.open()})}else{this.byId("createApproverDialog").open()}},onUpdateApprover:function(){var e=this.getView();if(!this.byId("updateApproverDialog")){o.load({id:e.getId(),name:"vendorportal.view.UpdateApprover",controller:this}).then(function(t){e.addDependent(t);t.open()})}else{this.byId("updateApproverDialog").open()}},onSaveUpdateApprover:async function(){try{const e=this.byId("inputLevel1").getValue();const r=this.byId("inputCountry1").getValue();const o=this.byId("inputName1").getValue();const a=this.byId("inputEmail1").getValue();if(!e||!r||!o||!a){i.warning("Please fill all required fields.");return}const s={approverentry:{level:e,country:r,name:o,email:a}};const n=await fetch(this.getURL()+`/odata/v4/supplier/approverupdateentry`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});const l=await n.json();this.byId("inputLevel1").setValue("");this.byId("inputCountry1").setValue("");this.byId("inputName1").setValue("");this.byId("inputEmail1").setValue("");if(n.ok){t.show(l.value);this.byId("updateApproverDialog").close()}else{i.error(l.error?.message||"Failed to update approver")}}catch(e){i.error("Error: "+e.message)}},onSaveApprover:async function(){try{const e=this.byId("inputLevel").getValue();const r=this.byId("inputCountry").getValue();const o=this.byId("inputName").getValue();const a=this.byId("inputEmail").getValue();if(!e||!r||!o||!a){i.warning("Please fill all required fields.");return}const s={approverentry:{level:e,country:r,name:o,email:a}};const n=await fetch(this.getURL()+`/odata/v4/supplier/approverentry`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});const l=await n.json();this.byId("inputLevel").setValue("");this.byId("inputCountry").setValue("");this.byId("inputName").setValue("");this.byId("inputEmail").setValue("");if(n.ok){t.show(l.value);this.byId("createApproverDialog").close()}else{i.error(l.error?.message||"Failed to insert approver")}}catch(e){i.error("Error: "+e.message)}},onCancelApprover:function(){this.byId("createApproverDialog").close()},onCancelUpdateApprover:function(){this.byId("updateApproverDialog").close()}})});
//# sourceMappingURL=View1.controller.js.map