sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/Fragment"],function(e,t,i,o,s){"use strict";return e.extend("vendorportal.controller.View1",{getURL:function(){return sap.ui.require.toUrl("vendorportal")},onInit:function(){const e=new i({supplierData:{supplierName:"",businessPartnerId:"",mainAddress:{street:"",line2:"",line3:"",city:"",postalCode:"",country:"",region:""},primaryContact:{firstName:"",lastName:"",email:"",phone:""},categoryAndRegion:{category:"",region:""},additionalInfo:{details:""}},suppliers:[]});this.getView().setModel(e)},onFileChange:function(e){this._files=e.getParameter("files")||[];t.show(`${this._files.length} file(s) selected.`)},onSaveSupplier:function(){const e=this.getView().getModel().getProperty("/supplierData");if(!e.supplierName){o.warning("Please enter Supplier Name before saving.");return}fetch(this.getURL()+`/odata/v4/supplier/createSupplierWithFiles`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({supplierData:e})}).then(e=>e.json()).then(i=>{t.show(i.value);if(this._files&&this._files.length>0){const i=new FormData;i.append("supplierName",e.supplierName);Array.from(this._files).forEach(e=>{i.append("files",e)});fetch(this.getURL()+`/uploadattachments`,{method:"POST",body:i}).then(e=>e.json()).then(e=>{t.show(e.message)}).catch(e=>o.error("File upload error: "+e.message))}this._resetForm();const s=this.byId("createWizard");if(s){const e=this.byId("step1");s.discardProgress(e)}}).catch(e=>{o.error("Error saving supplier: "+e.message)})},_resetForm:function(){this.getView().getModel().setProperty("/supplierData",{supplierName:"",mainAddress:{street:"",line2:"",line3:"",city:"",postalCode:"",country:"",region:""},primaryContact:{firstName:"",lastName:"",email:"",phone:""},categoryAndRegion:{category:"",region:""},additionalInfo:{details:""}});this._files=[];const e=this.byId("fileUploader");if(e)e.clear()},onOpenSupplierList:function(){const e=this.getView();if(!this._oSupplierDialog){s.load({id:e.getId(),name:"vendorportal.view.SupplierList",controller:this}).then(t=>{this._oSupplierDialog=t;e.addDependent(this._oSupplierDialog);this._fetchSuppliers();this._oSupplierDialog.open()})}else{this._fetchSuppliers();this._oSupplierDialog.open()}},onCloseSupplierList:function(){if(this._oSupplierDialog)this._oSupplierDialog.close()},_fetchSuppliers:function(){fetch(this.getURL()+`/odata/v4/supplier/getsuppliers`).then(e=>e.json()).then(e=>{const t=Array.isArray(e.value)?e.value:e;this.getView().getModel().setProperty("/suppliers",t)}).catch(e=>{o.error("Error fetching suppliers: "+e.message)})},onViewSupplier:function(e){const t=e.getSource().getBindingContext().getObject();const o=this.getView();if(!this._oSupplierDetailsDialog){s.load({id:o.getId(),name:"vendorportal.view.SupplierDetails",controller:this}).then(e=>{this._oSupplierDetailsDialog=e;o.addDependent(this._oSupplierDetailsDialog);e.setModel(new i(t),"selectedSupplier");this._loadAttachments(t.supplierName);e.open()})}else{this._oSupplierDetailsDialog.setModel(new i(t),"selectedSupplier");this._loadAttachments(t.supplierName);this._oSupplierDetailsDialog.open()}},onCloseSupplierDetails:function(){if(this._oSupplierDetailsDialog){this._oSupplierDetailsDialog.close()}},_loadAttachments:function(e){fetch(this.getURL()+`/odata/v4/supplier/downloadAttachments(supplierName='${encodeURIComponent(e)}')`).then(e=>e.json()).then(e=>{const t=Array.isArray(e)?e:e.value||[];const o=new i({attachments:t});this._oSupplierDetailsDialog.setModel(o,"attachmentsModel")}).catch(e=>{o.error("Error loading attachments: "+e.message)})},onDownloadAttachment:function(e){const t=e.getSource().getBindingContext("attachmentsModel").getObject();if(!t||!t.fileName){o.warning("File information missing.");return}const i=this._base64ToBlob(t.content,t.mimeType);const s=document.createElement("a");s.href=URL.createObjectURL(i);s.download=t.fileName;s.click();URL.revokeObjectURL(s.href)},_base64ToBlob:function(e,t){t=t||"";const i=512;const o=atob(e);const s=[];for(let e=0;e<o.length;e+=i){const t=o.slice(e,e+i);const r=new Array(t.length);for(let e=0;e<t.length;e++){r[e]=t.charCodeAt(e)}s.push(new Uint8Array(r))}return new Blob(s,{type:t})},onViewStatus:function(e){const t=e.getSource().getBindingContext().getObject();const i=this.getView();fetch(this.getURL()+`/odata/v4/supplier/Approvals?suppliername=${t.supplierName}`).then(e=>{if(!e.ok){throw new Error("Failed to fetch supplier status")}return e.json()}).then(e=>{const t=e.value||[];const o=new sap.ui.model.json.JSONModel({status:t});i.setModel(o,"statusModel");if(!this._oSupplierStatusDialog){sap.ui.core.Fragment.load({id:i.getId(),name:"vendorportal.view.SupplierStatus",controller:this}).then(e=>{this._oSupplierStatusDialog=e;i.addDependent(this._oSupplierStatusDialog);this._oSupplierStatusDialog.open()})}else{this._oSupplierStatusDialog.open()}}).catch(e=>{sap.m.MessageToast.show("Error: "+e.message)})},onCloseSupplierStatus:function(){if(this._oSupplierStatusDialog){this._oSupplierStatusDialog.close()}},onOpenApproverList:async function(){var e=this.getView();if(!this._oApproverDialog){this._oApproverDialog=await s.load({id:e.getId(),name:"vendorportal.view.ApproverList",controller:this});e.addDependent(this._oApproverDialog)}fetch(this.getURL()+`/odata/v4/supplier/Approvers`).then(e=>e.json()).then(e=>{const t=Array.isArray(e.value)?e.value:e;this.getView().getModel().setProperty("/approvers",t)}).catch(e=>{o.error("Error fetching suppliers: "+e.message)});this._oApproverDialog.open()},onCloseApproverList:function(){if(this._oApproverDialog){this._oApproverDialog.close()}},onCreateApprover:function(){var e=this.getView();if(!this.byId("createApproverDialog")){s.load({id:e.getId(),name:"vendorportal.view.CreateApprover",controller:this}).then(function(t){e.addDependent(t);t.open()})}else{this.byId("createApproverDialog").open()}},onSaveApprover:async function(){try{const e=this.byId("inputLevel").getValue();const i=this.byId("inputCountry").getValue();const s=this.byId("inputName").getValue();const r=this.byId("inputEmail").getValue();if(!e||!i||!s||!r){o.warning("Please fill all required fields.");return}const a={approverentry:{level:e,country:i,name:s,email:r}};const n=await fetch(this.getURL()+`/odata/v4/supplier/approverentry`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});const l=await n.json();if(n.ok){t.show(l.value);this.byId("createApproverDialog").close()}else{o.error(l.error?.message||"Failed to insert approver")}}catch(e){o.error("Error: "+e.message)}},onCancelApprover:function(){this.byId("createApproverDialog").close()}})});
//# sourceMappingURL=View1.controller.js.map