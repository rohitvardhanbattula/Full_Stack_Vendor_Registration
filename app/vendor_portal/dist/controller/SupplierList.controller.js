sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/Fragment"],function(e,t,i,s,o){"use strict";return e.extend("vendorportal.controller.SupplierList",{onInit:function(){this._startAutoRefresh()},_startAutoRefresh:function(){if(this._refreshInterval){clearInterval(this._refreshInterval)}this._fetchSuppliers();this._refreshInterval=setInterval(()=>{if(this.getView().getDomRef()){this._fetchSuppliers()}},5e3)},onExit:function(){if(this._refreshInterval){clearInterval(this._refreshInterval);this._refreshInterval=null}},getURL:function(){return sap.ui.require.toUrl("vendorportal")},_fetchSuppliers:function(){const e=this.getView();const t=e.byId("supplierTable");const o=t?t.getBinding("items"):null;const r=e.getModel()||new i({suppliers:[]});if(!e.getModel())e.setModel(r);const n=o?o.aFilters:[];fetch(this.getURL()+`/odata/v4/supplier/getsuppliers`).then(e=>e.json()).then(e=>{const t=Array.isArray(e.value)?e.value:e;r.setProperty("/suppliers",t);if(o){o.filter(n)}}).catch(e=>{s.error("Error fetching suppliers: "+e.message)})},onViewSupplier:function(e){const t=e.getSource().getBindingContext().getObject();const s=this.getView();if(!this._oSupplierDetailsDialog){o.load({id:s.getId(),name:"vendorportal.view.SupplierDetails",controller:this}).then(e=>{this._oSupplierDetailsDialog=e;s.addDependent(this._oSupplierDetailsDialog);e.setModel(new i(t),"selectedSupplier");this._loadAttachments(t.supplierName);e.open()})}else{this._oSupplierDetailsDialog.setModel(new i(t),"selectedSupplier");this._loadAttachments(t.supplierName);this._oSupplierDetailsDialog.open()}},onCloseSupplierDetails:function(){if(this._oSupplierDetailsDialog){this._oSupplierDetailsDialog.close()}},_loadAttachments:function(e){fetch(this.getURL()+`/odata/v4/supplier/downloadAttachments(supplierName='${encodeURIComponent(e)}')`).then(e=>e.json()).then(e=>{const t=Array.isArray(e)?e:e.value||[];const s=new i({attachments:t});this._oSupplierDetailsDialog.setModel(s,"attachmentsModel")}).catch(e=>{s.error("Error loading attachments: "+e.message)})},onDownloadAttachment:function(e){const t=e.getSource().getBindingContext("attachmentsModel").getObject();if(!t||!t.fileName){s.warning("File information missing.");return}const i=this._base64ToBlob(t.content,t.mimeType);const o=document.createElement("a");o.href=URL.createObjectURL(i);o.download=t.fileName;o.click();URL.revokeObjectURL(o.href)},_base64ToBlob:function(e,t){t=t||"";const i=512;const s=atob(e);const o=[];for(let e=0;e<s.length;e+=i){const t=s.slice(e,e+i);const r=new Array(t.length);for(let e=0;e<t.length;e++){r[e]=t.charCodeAt(e)}o.push(new Uint8Array(r))}return new Blob(o,{type:t})},onViewStatus:function(e){const t=e.getSource().getBindingContext().getObject();const i=this.getView();fetch(this.getURL()+`/odata/v4/supplier/Approvals?suppliername=${t.supplierName}`).then(e=>{if(!e.ok){throw new Error("Failed to fetch supplier status")}return e.json()}).then(e=>{const t=e.value||[];const s=new sap.ui.model.json.JSONModel({status:t});i.setModel(s,"statusModel");if(!this._oSupplierStatusDialog){sap.ui.core.Fragment.load({id:i.getId(),name:"vendorportal.view.SupplierStatus",controller:this}).then(e=>{this._oSupplierStatusDialog=e;i.addDependent(this._oSupplierStatusDialog);this._oSupplierStatusDialog.open()})}else{this._oSupplierStatusDialog.open()}}).catch(e=>{sap.m.MessageToast.show("Error: "+e.message)})},onCloseSupplierStatus:function(){if(this._oSupplierStatusDialog){this._oSupplierStatusDialog.close()}},onNavBack:function(){const e=sap.ui.core.routing.History.getInstance();const t=e.getPreviousHash();if(t!==undefined){window.history.go(-1)}else{this.getOwnerComponent().getRouter().navTo("View1",{},true)}},formatStatusType:function(e){if(!e)return"Transparent";e=e.toUpperCase();if(e==="APPROVED")return"Accept";if(e==="REJECTED")return"Reject";if(e==="PENDING")return"Attention";return"Transparent"},onFilterSuppliers:function(){var e=this.byId("supplierTable");var t=e.getBinding("items");var i=this.byId("filterName").getValue();var s=this.byId("filterCity").getValue();var o=this.byId("filterStatus").getSelectedKey();var r=[];if(i){r.push(new sap.ui.model.Filter("supplierName",sap.ui.model.FilterOperator.Contains,i))}if(s){r.push(new sap.ui.model.Filter("mainAddress/city",sap.ui.model.FilterOperator.Contains,s))}if(o){r.push(new sap.ui.model.Filter("status",sap.ui.model.FilterOperator.EQ,o))}t.filter(r)},onClearFilters:function(){this.byId("filterName").setValue("");this.byId("filterCity").setValue("");this.byId("filterStatus").setSelectedKey("");this.onFilterSuppliers()}})});
//# sourceMappingURL=SupplierList.controller.js.map